#/bin/bash

ARUSPIX_ROOT=../
EMCC=`which emcc`

if [ ! -d build ]; then mkdir build; fi

if [ ! -d data ]; then mkdir data; fi

echo "Sync svg resources"
cp -r ../data/svg data/

echo "Compliling"
# we use ASM_JS=0 because otherwise it does not work with FireFox
# memory is increased (TOTAL_MEMORY and TOTAL_STACK) for processing large files (tested up to 7MB)

python $EMCC --closure 0 -O2 \
	-s ASM_JS=1 \
	-s OUTLINING_LIMIT=160000 \
	-I$ARUSPIX_ROOT/src \
	-I./lib/jsonxx \
	-DUSE_EMSCRIPTEN \
	-s TOTAL_MEMORY=256*1024*1024 \
	-s TOTAL_STACK=16*1024*1024 \
	$ARUSPIX_ROOT/src/mus/emscripten_main.cpp \
	$ARUSPIX_ROOT/src/mus/mus.cpp \
	$ARUSPIX_ROOT/src/mus/musaligner.cpp \
	$ARUSPIX_ROOT/src/mus/musapp.cpp \
	$ARUSPIX_ROOT/src/mus/musbarline.cpp \
	$ARUSPIX_ROOT/src/mus/musmeasure.cpp \
	$ARUSPIX_ROOT/src/mus/musbboxdc.cpp \
	$ARUSPIX_ROOT/src/mus/musbeam.cpp \
	$ARUSPIX_ROOT/src/mus/musclef.cpp \
	$ARUSPIX_ROOT/src/mus/muscontroller.cpp \
	$ARUSPIX_ROOT/src/mus/musdc.cpp \
	$ARUSPIX_ROOT/src/mus/musdoc.cpp \
	$ARUSPIX_ROOT/src/mus/musdurationinterface.cpp \
	$ARUSPIX_ROOT/src/mus/musio.cpp \
	$ARUSPIX_ROOT/src/mus/musiodarms.cpp \
	$ARUSPIX_ROOT/src/mus/musiomei.cpp \
	$ARUSPIX_ROOT/src/mus/musiomusxml.cpp \
	$ARUSPIX_ROOT/src/mus/musiopae.cpp \
	$ARUSPIX_ROOT/src/mus/muskeysig.cpp \
	$ARUSPIX_ROOT/src/mus/muslayer.cpp \
	$ARUSPIX_ROOT/src/mus/muslayerelement.cpp \
	$ARUSPIX_ROOT/src/mus/musleipzigbbox.cpp \
	$ARUSPIX_ROOT/src/mus/musmensur.cpp \
	$ARUSPIX_ROOT/src/mus/musmultirest.cpp \
	$ARUSPIX_ROOT/src/mus/musnote.cpp \
	$ARUSPIX_ROOT/src/mus/musobject.cpp \
	$ARUSPIX_ROOT/src/mus/muspage.cpp \
	$ARUSPIX_ROOT/src/mus/muspitchinterface.cpp \
	$ARUSPIX_ROOT/src/mus/muspositioninterface.cpp \
	$ARUSPIX_ROOT/src/mus/musrc.cpp \
	$ARUSPIX_ROOT/src/mus/musrc_beam.cpp \
	$ARUSPIX_ROOT/src/mus/musrc_bezier.cpp \
	$ARUSPIX_ROOT/src/mus/musrc_element.cpp \
	$ARUSPIX_ROOT/src/mus/musrc_graph.cpp \
	$ARUSPIX_ROOT/src/mus/musrc_page.cpp \
	$ARUSPIX_ROOT/src/mus/musrc_tuplet.cpp \
	$ARUSPIX_ROOT/src/mus/musrest.cpp \
	$ARUSPIX_ROOT/src/mus/musscoredef.cpp \
	$ARUSPIX_ROOT/src/mus/musslur.cpp \
	$ARUSPIX_ROOT/src/mus/musstaff.cpp \
	$ARUSPIX_ROOT/src/mus/mussvgdc.cpp \
	$ARUSPIX_ROOT/src/mus/mussymbol.cpp \
	$ARUSPIX_ROOT/src/mus/mussystem.cpp \
	$ARUSPIX_ROOT/src/mus/mustie.cpp \
	$ARUSPIX_ROOT/src/mus/mustuplet.cpp \
	$ARUSPIX_ROOT/src/tinyxml/tinystr.cpp \
	$ARUSPIX_ROOT/src/tinyxml/tinyxml.cpp \
	$ARUSPIX_ROOT/src/tinyxml/tinyxmlerror.cpp \
	$ARUSPIX_ROOT/src/tinyxml/tinyxmlparser.cpp \
	lib/jsonxx/jsonxx.cc \
	--embed-file data/svg/ \
	-s EXPORTED_FUNCTIONS="['_convertMusic']" \
    -o build/aruspix.js

if [ $? -eq 0 ]; then echo "Done."; fi

# Unused

#	lib/regex/regcomp.c \
#	lib/regex/regexec.c \
#	lib/regex/regfree.c \
#	lib/regex/regerror.c \

#/Users/xhero/Downloads/e2fsprogs-1.42.8/lib/uuid/result.bc \
#--embed-file data/svg/ \
#	llvm_regexp/regcomp.c \
#	llvm_regexp/regexec.c \
#	llvm_regexp/regfree.c \
#	llvm_regexp/regerror.c \
#	llvm_regexp/regstrlcpy.c \

#	apple_regex/regcomp.c \
#	apple_regex/regexec.c \
#	apple_regex/regfree.c \
#	apple_regex/regerror.c \
